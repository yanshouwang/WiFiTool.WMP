"use strict";
var serviceId = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
function inArray(arr, key, val) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i][key] === val) {
            return i;
        }
    }
    return -1;
}
var obj = [];
var hide = false;
Page({
    data: {
        available: false,
        discovering: false,
        devices: obj
    },
    onLoad: function () {
        var _this = this;
        console.log("index: onLoad");
        wx.onBluetoothAdapterStateChange(function (res) { return _this.onAdapterStateChange(res); });
        wx.onBluetoothDeviceFound(function (res) { return _this.onDeviceFound(res); });
        this.openAdapter();
    },
    onReady: function () {
        console.log("index: onReady");
    },
    onShow: function () {
        console.log("index: onShow");
        hide = false;
        if (this.data.available && !this.data.discovering) {
            this.startDiscovery();
        }
    },
    onHide: function () {
        console.log("index: onHide");
        hide = true;
        if (this.data.available && this.data.discovering) {
            this.stopDiscovery();
        }
    },
    onUnload: function () {
        console.log("index: onUnload");
        this.closeAdapter();
    },
    onPullDownRefresh: function () {
        var data = {};
        data["devices"] = [];
        this.setData(data);
        wx.stopPullDownRefresh();
    },
    onTapDevice: function (e) {
        var i = e.currentTarget.id;
        var device = this.data.devices[i];
        var option = {
            url: "../device/device",
            success: function (res) { return res.eventChannel.emit("device", device); }
        };
        wx.navigateTo(option);
    },
    onAdapterStateChange: function (res) {
        console.log("\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u6539\u53D8\uFF1A" + res.available + " - " + res.discovering);
        var data = {
            "available": res.available,
            "discovering": res.discovering
        };
        this.setData(data);
        if (res.available) {
            if (hide && res.discovering) {
                this.stopDiscovery();
            }
            else if (!hide && !res.discovering) {
                this.startDiscovery();
            }
        }
    },
    onDeviceFound: function (res) {
        var _this = this;
        res.devices.forEach(function (device) {
            var data = {};
            var i = inArray(_this.data.devices, 'deviceId', device.deviceId);
            if (i === -1) {
                console.log("\u53D1\u73B0\u8BBE\u5907\uFF1A" + JSON.stringify(device));
                var length = _this.data.devices.length;
                data["devices[" + length + "]"] = device;
            }
            else {
                data["devices[" + i + "]"] = device;
            }
            _this.setData(data);
        });
    },
    openAdapter: function () {
        var _this = this;
        var option = {
            success: function () {
                console.log("打开蓝牙模块成功");
                _this.onAdapterOpen();
            },
            fail: function (res) { return console.log("\u6253\u5F00\u84DD\u7259\u6A21\u5757\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.openBluetoothAdapter(option);
    },
    onAdapterOpen: function () {
        var _this = this;
        var option1 = {
            success: function (res) {
                console.log("\u83B7\u53D6\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u6210\u529F\uFF1A" + res.available + " - " + res.discovering);
                _this.onAdapterStateChange(res);
            },
            fail: function (res) { return console.log("\u83B7\u53D6\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.getBluetoothAdapterState(option1);
    },
    closeAdapter: function () {
        var option = {
            success: function () { return console.log("关闭蓝牙模块成功"); },
            fail: function (res) { return console.log("\u5173\u95ED\u84DD\u7259\u6A21\u5757\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.closeBluetoothAdapter(option);
    },
    startDiscovery: function () {
        var option = {
            allowDuplicatesKey: true,
            services: [serviceId],
            success: function () { return console.log("开始扫描成功"); },
            fail: function (res) { return console.log("\u5F00\u59CB\u626B\u63CF\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.startBluetoothDevicesDiscovery(option);
    },
    stopDiscovery: function () {
        var option = {
            success: function () { return console.log("停止扫描成功"); },
            fail: function (res) { return console.log("\u505C\u6B62\u626B\u63CF\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.stopBluetoothDevicesDiscovery(option);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsSUFBTSxTQUFTLEdBQVcsc0NBQXNDLENBQUM7QUFFakUsU0FBUyxPQUFPLENBQUMsR0FBbUIsRUFBRSxHQUFvQixFQUFFLEdBQVE7SUFDbEUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDbkMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3ZCLE9BQU8sQ0FBQyxDQUFDO1NBQ1Y7S0FDRjtJQUNELE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDWixDQUFDO0FBRUQsSUFBTSxHQUFHLEdBQXNELEVBVTlELENBQUM7QUFFRixJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7QUFFakIsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osU0FBUyxFQUFFLEtBQUs7UUFDaEIsV0FBVyxFQUFFLEtBQUs7UUFDbEIsT0FBTyxFQUFFLEdBQUc7S0FDYjtJQVFELE1BQU07UUFBTixpQkFPQztRQU5DLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFN0IsRUFBRSxDQUFDLDZCQUE2QixDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxFQUE5QixDQUE4QixDQUFDLENBQUM7UUFDeEUsRUFBRSxDQUFDLHNCQUFzQixDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBdkIsQ0FBdUIsQ0FBQyxDQUFDO1FBRTFELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUVoQyxDQUFDO0lBRUQsTUFBTTtRQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFN0IsSUFBSSxHQUFHLEtBQUssQ0FBQztRQUNiLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNqRCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDdkI7SUFDSCxDQUFDO0lBRUQsTUFBTTtRQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFN0IsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNaLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDaEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUVELFFBQVE7UUFDTixPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFHL0IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFFRCxpQkFBaUI7UUFDZixJQUFNLElBQUksR0FBd0IsRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQixFQUFFLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQU8zQixDQUFDO0lBRUQsV0FBVyxZQUFDLENBQU07UUFDaEIsSUFBTSxDQUFDLEdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7UUFDckMsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsSUFBTSxNQUFNLEdBQXVDO1lBQ2pELEdBQUcsRUFBRSxrQkFBa0I7WUFDdkIsT0FBTyxFQUFFLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUF2QyxDQUF1QztTQUN4RCxDQUFDO1FBQ0YsRUFBRSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRUQsb0JBQW9CLFlBQUMsR0FBa0U7UUFDckYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpRUFBYSxHQUFHLENBQUMsU0FBUyxXQUFNLEdBQUcsQ0FBQyxXQUFhLENBQUMsQ0FBQztRQUUvRCxJQUFNLElBQUksR0FBd0I7WUFDaEMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxTQUFTO1lBQzFCLGFBQWEsRUFBRSxHQUFHLENBQUMsV0FBVztTQUMvQixDQUFDO1FBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVuQixJQUFJLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDakIsSUFBSSxJQUFJLElBQUksR0FBRyxDQUFDLFdBQVcsRUFBRTtnQkFDM0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQ3RCO2lCQUFNLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFO2dCQUNwQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7YUFDdkI7U0FDRjtJQUNILENBQUM7SUFFRCxhQUFhLFlBQUMsR0FBMkQ7UUFBekUsaUJBY0M7UUFiQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLE1BQU07WUFDeEIsSUFBTSxJQUFJLEdBQTJCLEVBQUUsQ0FBQztZQUN4QyxJQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNsRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDWixPQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFRLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFHLENBQUMsQ0FBQztnQkFFOUMsSUFBTSxNQUFNLEdBQUcsS0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO2dCQUN4QyxJQUFJLENBQUMsYUFBVyxNQUFNLE1BQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQzthQUNyQztpQkFBTTtnQkFDTCxJQUFJLENBQUMsYUFBVyxDQUFDLE1BQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQzthQUNoQztZQUNELEtBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsV0FBVztRQUFYLGlCQVVDO1FBVEMsSUFBTSxNQUFNLEdBQWlEO1lBQzNELE9BQU8sRUFBRTtnQkFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUV4QixLQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsQ0FBQztZQUNELElBQUksRUFBRSxVQUFBLEdBQUcsSUFBSSxPQUFBLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkRBQVksR0FBRyxDQUFDLE9BQU8sV0FBTSxHQUFHLENBQUMsTUFBUSxDQUFDLEVBQXRELENBQXNEO1NBQ3BFLENBQUM7UUFDRixFQUFFLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELGFBQWE7UUFBYixpQkFVQztRQVRDLElBQU0sT0FBTyxHQUFxRDtZQUNoRSxPQUFPLEVBQUUsVUFBQSxHQUFHO2dCQUNWLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkVBQWUsR0FBRyxDQUFDLFNBQVMsV0FBTSxHQUFHLENBQUMsV0FBYSxDQUFDLENBQUM7Z0JBRWpFLEtBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqQyxDQUFDO1lBQ0QsSUFBSSxFQUFFLFVBQUEsR0FBRyxJQUFJLE9BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2RUFBZSxHQUFHLENBQUMsT0FBTyxXQUFNLEdBQUcsQ0FBQyxNQUFRLENBQUMsRUFBekQsQ0FBeUQ7U0FDdkUsQ0FBQztRQUNGLEVBQUUsQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsWUFBWTtRQUNWLElBQU0sTUFBTSxHQUFrRDtZQUM1RCxPQUFPLEVBQUUsY0FBTSxPQUFBLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQXZCLENBQXVCO1lBQ3RDLElBQUksRUFBRSxVQUFBLEdBQUcsSUFBSSxPQUFBLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkRBQVksR0FBRyxDQUFDLE9BQU8sV0FBTSxHQUFHLENBQUMsTUFBUSxDQUFDLEVBQXRELENBQXNEO1NBQ3BFLENBQUM7UUFDRixFQUFFLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELGNBQWM7UUFDWixJQUFNLE1BQU0sR0FBMkQ7WUFDckUsa0JBQWtCLEVBQUUsSUFBSTtZQUN4QixRQUFRLEVBQUUsQ0FBQyxTQUFTLENBQUM7WUFDckIsT0FBTyxFQUFFLGNBQU0sT0FBQSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFyQixDQUFxQjtZQUNwQyxJQUFJLEVBQUUsVUFBQSxHQUFHLElBQUksT0FBQSxPQUFPLENBQUMsR0FBRyxDQUFDLCtDQUFVLEdBQUcsQ0FBQyxPQUFPLFdBQU0sR0FBRyxDQUFDLE1BQVEsQ0FBQyxFQUFwRCxDQUFvRDtTQUNsRSxDQUFBO1FBQ0QsRUFBRSxDQUFDLDhCQUE4QixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxhQUFhO1FBQ1gsSUFBTSxNQUFNLEdBQTBEO1lBQ3BFLE9BQU8sRUFBRSxjQUFNLE9BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBckIsQ0FBcUI7WUFDcEMsSUFBSSxFQUFFLFVBQUEsR0FBRyxJQUFJLE9BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQ0FBVSxHQUFHLENBQUMsT0FBTyxXQUFNLEdBQUcsQ0FBQyxNQUFRLENBQUMsRUFBcEQsQ0FBb0Q7U0FDbEUsQ0FBQztRQUNGLEVBQUUsQ0FBQyw2QkFBNkIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMzQyxDQUFDO0NBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW5kZXgudHNcclxuY29uc3Qgc2VydmljZUlkOiBzdHJpbmcgPSBcIjZFNDAwMDAxLUI1QTMtRjM5My1FMEE5LUU1MEUyNERDQ0E5RVwiO1xyXG5cclxuZnVuY3Rpb24gaW5BcnJheShhcnI6IHN0cmluZyB8IGFueVtdLCBrZXk6IHN0cmluZyB8IG51bWJlciwgdmFsOiBhbnkpIHtcclxuICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xyXG4gICAgaWYgKGFycltpXVtrZXldID09PSB2YWwpIHtcclxuICAgICAgcmV0dXJuIGk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiAtMTtcclxufVxyXG5cclxuY29uc3Qgb2JqOiBXZWNoYXRNaW5pcHJvZ3JhbS5DYWxsYmFja1Jlc3VsdEJsdWVUb290aERldmljZVtdID0gW1xyXG4gIC8vIHtcclxuICAvLyAgIGFkdmVydGlzRGF0YTogbmV3IEFycmF5QnVmZmVyKDApLFxyXG4gIC8vICAgYWR2ZXJ0aXNTZXJ2aWNlVVVJRHM6IFtdLFxyXG4gIC8vICAgc2VydmljZURhdGE6IHt9LFxyXG4gIC8vICAgZGV2aWNlSWQ6IFwiQUE4NjczMEQtQzY1MS00QTNFLUFCNDAtQzFDN0EzRUJDRTlGXCIsXHJcbiAgLy8gICBuYW1lOiBcIlRFU1QgMDFcIixcclxuICAvLyAgIGxvY2FsTmFtZTogXCJXZSBUZXN0XCIsXHJcbiAgLy8gICBSU1NJOiAtNTlcclxuICAvLyB9XHJcbl07XHJcblxyXG5sZXQgaGlkZSA9IGZhbHNlO1xyXG5cclxuUGFnZSh7XHJcbiAgZGF0YToge1xyXG4gICAgYXZhaWxhYmxlOiBmYWxzZSxcclxuICAgIGRpc2NvdmVyaW5nOiBmYWxzZSxcclxuICAgIGRldmljZXM6IG9ialxyXG4gIH0sXHJcblxyXG4gIC8vIG9uVGVzdCgpIHtcclxuICAvLyAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuICAvLyAgIGRhdGFbXCJhdmFpbGFibGVcIl0gPSAhdGhpcy5kYXRhLmF2YWlsYWJsZTtcclxuICAvLyAgIHRoaXMuc2V0RGF0YShkYXRhKTtcclxuICAvLyB9LFxyXG5cclxuICBvbkxvYWQoKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcImluZGV4OiBvbkxvYWRcIik7XHJcblxyXG4gICAgd3gub25CbHVldG9vdGhBZGFwdGVyU3RhdGVDaGFuZ2UocmVzID0+IHRoaXMub25BZGFwdGVyU3RhdGVDaGFuZ2UocmVzKSk7XHJcbiAgICB3eC5vbkJsdWV0b290aERldmljZUZvdW5kKHJlcyA9PiB0aGlzLm9uRGV2aWNlRm91bmQocmVzKSk7XHJcbiAgICAvLyDliJ3lp4vljJbok53niZnmqKHlnZdcclxuICAgIHRoaXMub3BlbkFkYXB0ZXIoKTtcclxuICB9LFxyXG5cclxuICBvblJlYWR5KCkge1xyXG4gICAgY29uc29sZS5sb2coXCJpbmRleDogb25SZWFkeVwiKTtcclxuXHJcbiAgfSxcclxuXHJcbiAgb25TaG93KCkge1xyXG4gICAgY29uc29sZS5sb2coXCJpbmRleDogb25TaG93XCIpO1xyXG5cclxuICAgIGhpZGUgPSBmYWxzZTtcclxuICAgIGlmICh0aGlzLmRhdGEuYXZhaWxhYmxlICYmICF0aGlzLmRhdGEuZGlzY292ZXJpbmcpIHtcclxuICAgICAgdGhpcy5zdGFydERpc2NvdmVyeSgpO1xyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIG9uSGlkZSgpIHtcclxuICAgIGNvbnNvbGUubG9nKFwiaW5kZXg6IG9uSGlkZVwiKTtcclxuXHJcbiAgICBoaWRlID0gdHJ1ZTtcclxuICAgIGlmICh0aGlzLmRhdGEuYXZhaWxhYmxlICYmIHRoaXMuZGF0YS5kaXNjb3ZlcmluZykge1xyXG4gICAgICB0aGlzLnN0b3BEaXNjb3ZlcnkoKTtcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBvblVubG9hZCgpIHtcclxuICAgIGNvbnNvbGUubG9nKFwiaW5kZXg6IG9uVW5sb2FkXCIpO1xyXG5cclxuICAgIC8vIOWFs+mXreiTneeJmeaooeWdl1xyXG4gICAgdGhpcy5jbG9zZUFkYXB0ZXIoKTtcclxuICB9LFxyXG5cclxuICBvblB1bGxEb3duUmVmcmVzaCgpIHtcclxuICAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuICAgIGRhdGFbXCJkZXZpY2VzXCJdID0gW107XHJcbiAgICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgICB3eC5zdG9wUHVsbERvd25SZWZyZXNoKCk7XHJcblxyXG4gICAgLy8gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAvLyAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuICAgIC8vICAgZGF0YVtcImRldmljZXNcIl0gPSBvYmo7XHJcbiAgICAvLyAgIHRoaXMuc2V0RGF0YShkYXRhKTtcclxuICAgIC8vIH0sIDUwMDApO1xyXG4gIH0sXHJcblxyXG4gIG9uVGFwRGV2aWNlKGU6IGFueSkge1xyXG4gICAgY29uc3QgaTogbnVtYmVyID0gZS5jdXJyZW50VGFyZ2V0LmlkO1xyXG4gICAgY29uc3QgZGV2aWNlID0gdGhpcy5kYXRhLmRldmljZXNbaV07XHJcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLk5hdmlnYXRlVG9PcHRpb24gPSB7XHJcbiAgICAgIHVybDogXCIuLi9kZXZpY2UvZGV2aWNlXCIsXHJcbiAgICAgIHN1Y2Nlc3M6IHJlcyA9PiByZXMuZXZlbnRDaGFubmVsLmVtaXQoXCJkZXZpY2VcIiwgZGV2aWNlKVxyXG4gICAgfTtcclxuICAgIHd4Lm5hdmlnYXRlVG8ob3B0aW9uKTtcclxuICB9LFxyXG5cclxuICBvbkFkYXB0ZXJTdGF0ZUNoYW5nZShyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLk9uQmx1ZXRvb3RoQWRhcHRlclN0YXRlQ2hhbmdlQ2FsbGJhY2tSZXN1bHQpIHtcclxuICAgIGNvbnNvbGUubG9nKGDok53niZnpgILphY3lmajnirbmgIHmlLnlj5jvvJoke3Jlcy5hdmFpbGFibGV9IC0gJHtyZXMuZGlzY292ZXJpbmd9YCk7XHJcblxyXG4gICAgY29uc3QgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcclxuICAgICAgXCJhdmFpbGFibGVcIjogcmVzLmF2YWlsYWJsZSxcclxuICAgICAgXCJkaXNjb3ZlcmluZ1wiOiByZXMuZGlzY292ZXJpbmdcclxuICAgIH07XHJcbiAgICB0aGlzLnNldERhdGEoZGF0YSk7XHJcblxyXG4gICAgaWYgKHJlcy5hdmFpbGFibGUpIHtcclxuICAgICAgaWYgKGhpZGUgJiYgcmVzLmRpc2NvdmVyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5zdG9wRGlzY292ZXJ5KCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoIWhpZGUgJiYgIXJlcy5kaXNjb3ZlcmluZykge1xyXG4gICAgICAgIHRoaXMuc3RhcnREaXNjb3ZlcnkoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIG9uRGV2aWNlRm91bmQocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5PbkJsdWV0b290aERldmljZUZvdW5kQ2FsbGJhY2tSZXN1bHQpIHtcclxuICAgIHJlcy5kZXZpY2VzLmZvckVhY2goZGV2aWNlID0+IHtcclxuICAgICAgY29uc3QgZGF0YTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xyXG4gICAgICBjb25zdCBpID0gaW5BcnJheSh0aGlzLmRhdGEuZGV2aWNlcywgJ2RldmljZUlkJywgZGV2aWNlLmRldmljZUlkKTtcclxuICAgICAgaWYgKGkgPT09IC0xKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYOWPkeeOsOiuvuWkh++8miR7SlNPTi5zdHJpbmdpZnkoZGV2aWNlKX1gKTtcclxuXHJcbiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5kYXRhLmRldmljZXMubGVuZ3RoO1xyXG4gICAgICAgIGRhdGFbYGRldmljZXNbJHtsZW5ndGh9XWBdID0gZGV2aWNlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRhdGFbYGRldmljZXNbJHtpfV1gXSA9IGRldmljZTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgICB9KTtcclxuICB9LFxyXG5cclxuICBvcGVuQWRhcHRlcigpIHtcclxuICAgIGNvbnN0IG9wdGlvbjogV2VjaGF0TWluaXByb2dyYW0uT3BlbkJsdWV0b290aEFkYXB0ZXJPcHRpb24gPSB7XHJcbiAgICAgIHN1Y2Nlc3M6ICgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIuaJk+W8gOiTneeJmeaooeWdl+aIkOWKn1wiKTtcclxuXHJcbiAgICAgICAgdGhpcy5vbkFkYXB0ZXJPcGVuKCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGZhaWw6IHJlcyA9PiBjb25zb2xlLmxvZyhg5omT5byA6JOd54mZ5qih5Z2X5aSx6LSl77yaJHtyZXMuZXJyQ29kZX0gLSAke3Jlcy5lcnJNc2d9YClcclxuICAgIH07XHJcbiAgICB3eC5vcGVuQmx1ZXRvb3RoQWRhcHRlcihvcHRpb24pO1xyXG4gIH0sXHJcblxyXG4gIG9uQWRhcHRlck9wZW4oKSB7XHJcbiAgICBjb25zdCBvcHRpb24xOiBXZWNoYXRNaW5pcHJvZ3JhbS5HZXRCbHVldG9vdGhBZGFwdGVyU3RhdGVPcHRpb24gPSB7XHJcbiAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYOiOt+WPluiTneeJmemAgumFjeWZqOeKtuaAgeaIkOWKn++8miR7cmVzLmF2YWlsYWJsZX0gLSAke3Jlcy5kaXNjb3ZlcmluZ31gKTtcclxuXHJcbiAgICAgICAgdGhpcy5vbkFkYXB0ZXJTdGF0ZUNoYW5nZShyZXMpO1xyXG4gICAgICB9LFxyXG4gICAgICBmYWlsOiByZXMgPT4gY29uc29sZS5sb2coYOiOt+WPluiTneeJmemAgumFjeWZqOeKtuaAgeWksei0pe+8miR7cmVzLmVyckNvZGV9IC0gJHtyZXMuZXJyTXNnfWApXHJcbiAgICB9O1xyXG4gICAgd3guZ2V0Qmx1ZXRvb3RoQWRhcHRlclN0YXRlKG9wdGlvbjEpO1xyXG4gIH0sXHJcblxyXG4gIGNsb3NlQWRhcHRlcigpIHtcclxuICAgIGNvbnN0IG9wdGlvbjogV2VjaGF0TWluaXByb2dyYW0uQ2xvc2VCbHVldG9vdGhBZGFwdGVyT3B0aW9uID0ge1xyXG4gICAgICBzdWNjZXNzOiAoKSA9PiBjb25zb2xlLmxvZyhcIuWFs+mXreiTneeJmeaooeWdl+aIkOWKn1wiKSxcclxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDlhbPpl63ok53niZnmqKHlnZflpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxyXG4gICAgfTtcclxuICAgIHd4LmNsb3NlQmx1ZXRvb3RoQWRhcHRlcihvcHRpb24pO1xyXG4gIH0sXHJcblxyXG4gIHN0YXJ0RGlzY292ZXJ5KCkge1xyXG4gICAgY29uc3Qgb3B0aW9uOiBXZWNoYXRNaW5pcHJvZ3JhbS5TdGFydEJsdWV0b290aERldmljZXNEaXNjb3ZlcnlPcHRpb24gPSB7XHJcbiAgICAgIGFsbG93RHVwbGljYXRlc0tleTogdHJ1ZSxcclxuICAgICAgc2VydmljZXM6IFtzZXJ2aWNlSWRdLFxyXG4gICAgICBzdWNjZXNzOiAoKSA9PiBjb25zb2xlLmxvZyhcIuW8gOWni+aJq+aPj+aIkOWKn1wiKSxcclxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDlvIDlp4vmiavmj4/lpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxyXG4gICAgfVxyXG4gICAgd3guc3RhcnRCbHVldG9vdGhEZXZpY2VzRGlzY292ZXJ5KG9wdGlvbik7XHJcbiAgfSxcclxuXHJcbiAgc3RvcERpc2NvdmVyeSgpIHtcclxuICAgIGNvbnN0IG9wdGlvbjogV2VjaGF0TWluaXByb2dyYW0uU3RvcEJsdWV0b290aERldmljZXNEaXNjb3ZlcnlPcHRpb24gPSB7XHJcbiAgICAgIHN1Y2Nlc3M6ICgpID0+IGNvbnNvbGUubG9nKFwi5YGc5q2i5omr5o+P5oiQ5YqfXCIpLFxyXG4gICAgICBmYWlsOiByZXMgPT4gY29uc29sZS5sb2coYOWBnOatouaJq+aPj+Wksei0pe+8miR7cmVzLmVyckNvZGV9IC0gJHtyZXMuZXJyTXNnfWApXHJcbiAgICB9O1xyXG4gICAgd3guc3RvcEJsdWV0b290aERldmljZXNEaXNjb3Zlcnkob3B0aW9uKTtcclxuICB9XHJcbn0pOyJdfQ==