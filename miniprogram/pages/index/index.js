"use strict";
var serviceId = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
function inArray(arr, key, val) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i][key] === val) {
            return i;
        }
    }
    return -1;
}
var obj = [];
var hide = false;
Page({
    data: {
        available: true,
        discovering: false,
        devices: obj
    },
    onLoad: function () {
        var _this = this;
        console.log("index: onLoad");
        wx.onBluetoothAdapterStateChange(function (res) { return _this.onAdapterStateChange(res); });
        wx.onBluetoothDeviceFound(function (res) { return _this.onDeviceFound(res); });
        this.openAdapter();
    },
    onReady: function () {
        console.log("index: onReady");
    },
    onShow: function () {
        console.log("index: onShow");
        hide = false;
        if (this.data.available && !this.data.discovering) {
            this.startDiscovery();
        }
    },
    onHide: function () {
        console.log("index: onHide");
        hide = true;
        if (this.data.available && this.data.discovering) {
            this.stopDiscovery();
        }
    },
    onUnload: function () {
        console.log("index: onUnload");
        this.closeAdapter();
    },
    onPullDownRefresh: function () {
        var data = {};
        data["devices"] = [];
        this.setData(data);
        wx.stopPullDownRefresh();
    },
    onTapDevice: function (e) {
        var i = e.currentTarget.id;
        var device = this.data.devices[i];
        var option = {
            url: "../device/device",
            success: function (res) { return res.eventChannel.emit("device", device); }
        };
        wx.navigateTo(option);
    },
    onAdapterStateChange: function (res) {
        console.log("\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u6539\u53D8\uFF1A" + res.available + " - " + res.discovering);
        var data = {
            "available": res.available,
            "discovering": res.discovering
        };
        this.setData(data);
        if (res.available) {
            if (hide && res.discovering) {
                this.stopDiscovery();
            }
            else if (!hide && !res.discovering) {
                this.startDiscovery();
            }
        }
    },
    onDeviceFound: function (res) {
        var _this = this;
        res.devices.forEach(function (device) {
            var data = {};
            var i = inArray(_this.data.devices, 'deviceId', device.deviceId);
            if (i === -1) {
                console.log("\u53D1\u73B0\u8BBE\u5907\uFF1A" + JSON.stringify(device));
                var length = _this.data.devices.length;
                data["devices[" + length + "]"] = device;
            }
            else {
                data["devices[" + i + "]"] = device;
            }
            _this.setData(data);
        });
    },
    openAdapter: function () {
        var _this = this;
        var option = {
            success: function () {
                console.log("打开蓝牙模块成功");
                _this.onAdapterOpen();
            },
            fail: function (res) { return console.log("\u6253\u5F00\u84DD\u7259\u6A21\u5757\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.openBluetoothAdapter(option);
    },
    onAdapterOpen: function () {
        var _this = this;
        var option1 = {
            success: function (res) {
                console.log("\u83B7\u53D6\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u6210\u529F\uFF1A" + res.available + " - " + res.discovering);
                _this.onAdapterStateChange(res);
            },
            fail: function (res) { return console.log("\u83B7\u53D6\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.getBluetoothAdapterState(option1);
    },
    closeAdapter: function () {
        var option = {
            success: function () { return console.log("关闭蓝牙模块成功"); },
            fail: function (res) { return console.log("\u5173\u95ED\u84DD\u7259\u6A21\u5757\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.closeBluetoothAdapter(option);
    },
    startDiscovery: function () {
        var option = {
            allowDuplicatesKey: true,
            services: [serviceId],
            success: function () { return console.log("开始扫描成功"); },
            fail: function (res) { return console.log("\u5F00\u59CB\u626B\u63CF\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.startBluetoothDevicesDiscovery(option);
    },
    stopDiscovery: function () {
        var option = {
            success: function () { return console.log("停止扫描成功"); },
            fail: function (res) { return console.log("\u505C\u6B62\u626B\u63CF\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.stopBluetoothDevicesDiscovery(option);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsSUFBTSxTQUFTLEdBQVcsc0NBQXNDLENBQUM7QUFFakUsU0FBUyxPQUFPLENBQUMsR0FBbUIsRUFBRSxHQUFvQixFQUFFLEdBQVE7SUFDbEUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDbkMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3ZCLE9BQU8sQ0FBQyxDQUFDO1NBQ1Y7S0FDRjtJQUNELE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDWixDQUFDO0FBRUQsSUFBTSxHQUFHLEdBQXNELEVBVTlELENBQUM7QUFFRixJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7QUFFakIsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osU0FBUyxFQUFFLElBQUk7UUFDZixXQUFXLEVBQUUsS0FBSztRQUNsQixPQUFPLEVBQUUsR0FBRztLQUNiO0lBUUQsTUFBTTtRQUFOLGlCQU9DO1FBTkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUU3QixFQUFFLENBQUMsNkJBQTZCLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLEVBQTlCLENBQThCLENBQUMsQ0FBQztRQUN4RSxFQUFFLENBQUMsc0JBQXNCLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxFQUF2QixDQUF1QixDQUFDLENBQUM7UUFFMUQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxPQUFPO1FBQ0wsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lB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QUM7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbmRleC50c1xyXG5jb25zdCBzZXJ2aWNlSWQ6IHN0cmluZyA9IFwiNkU0MDAwMDEtQjVBMy1GMzkzLUUwQTktRTUwRTI0RENDQTlFXCI7XHJcblxyXG5mdW5jdGlvbiBpbkFycmF5KGFycjogc3RyaW5nIHwgYW55W10sIGtleTogc3RyaW5nIHwgbnVtYmVyLCB2YWw6IGFueSkge1xyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBpZiAoYXJyW2ldW2tleV0gPT09IHZhbCkge1xyXG4gICAgICByZXR1cm4gaTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIC0xO1xyXG59XHJcblxyXG5jb25zdCBvYmo6IFdlY2hhdE1pbmlwcm9ncmFtLkNhbGxiYWNrUmVzdWx0Qmx1ZVRvb3RoRGV2aWNlW10gPSBbXHJcbiAgLy8ge1xyXG4gIC8vICAgYWR2ZXJ0aXNEYXRhOiBuZXcgQXJyYXlCdWZmZXIoMCksXHJcbiAgLy8gICBhZHZlcnRpc1NlcnZpY2VVVUlEczogW10sXHJcbiAgLy8gICBzZXJ2aWNlRGF0YToge30sXHJcbiAgLy8gICBkZXZpY2VJZDogXCJBQTg2NzMwRC1DNjUxLTRBM0UtQUI0MC1DMUM3QTNFQkNFOUZcIixcclxuICAvLyAgIG5hbWU6IFwiVEVTVCAwMVwiLFxyXG4gIC8vICAgbG9jYWxOYW1lOiBcIldlIFRlc3RcIixcclxuICAvLyAgIFJTU0k6IC01OVxyXG4gIC8vIH1cclxuXTtcclxuXHJcbmxldCBoaWRlID0gZmFsc2U7XHJcblxyXG5QYWdlKHtcclxuICBkYXRhOiB7XHJcbiAgICBhdmFpbGFibGU6IHRydWUsXHJcbiAgICBkaXNjb3ZlcmluZzogZmFsc2UsXHJcbiAgICBkZXZpY2VzOiBvYmpcclxuICB9LFxyXG5cclxuICAvLyBvblRlc3QoKSB7XHJcbiAgLy8gICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgLy8gICBkYXRhW1wiYXZhaWxhYmxlXCJdID0gIXRoaXMuZGF0YS5hdmFpbGFibGU7XHJcbiAgLy8gICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgLy8gfSxcclxuXHJcbiAgb25Mb2FkKCkge1xyXG4gICAgY29uc29sZS5sb2coXCJpbmRleDogb25Mb2FkXCIpO1xyXG5cclxuICAgIHd4Lm9uQmx1ZXRvb3RoQWRhcHRlclN0YXRlQ2hhbmdlKHJlcyA9PiB0aGlzLm9uQWRhcHRlclN0YXRlQ2hhbmdlKHJlcykpO1xyXG4gICAgd3gub25CbHVldG9vdGhEZXZpY2VGb3VuZChyZXMgPT4gdGhpcy5vbkRldmljZUZvdW5kKHJlcykpO1xyXG4gICAgLy8g5Yid5aeL5YyW6JOd54mZ5qih5Z2XXHJcbiAgICB0aGlzLm9wZW5BZGFwdGVyKCk7XHJcbiAgfSxcclxuXHJcbiAgb25SZWFkeSgpIHtcclxuICAgIGNvbnNvbGUubG9nKFwiaW5kZXg6IG9uUmVhZHlcIik7XHJcblxyXG4gIH0sXHJcblxyXG4gIG9uU2hvdygpIHtcclxuICAgIGNvbnNvbGUubG9nKFwiaW5kZXg6IG9uU2hvd1wiKTtcclxuXHJcbiAgICBoaWRlID0gZmFsc2U7XHJcbiAgICBpZiAodGhpcy5kYXRhLmF2YWlsYWJsZSAmJiAhdGhpcy5kYXRhLmRpc2NvdmVyaW5nKSB7XHJcbiAgICAgIHRoaXMuc3RhcnREaXNjb3ZlcnkoKTtcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBvbkhpZGUoKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcImluZGV4OiBvbkhpZGVcIik7XHJcblxyXG4gICAgaGlkZSA9IHRydWU7XHJcbiAgICBpZiAodGhpcy5kYXRhLmF2YWlsYWJsZSAmJiB0aGlzLmRhdGEuZGlzY292ZXJpbmcpIHtcclxuICAgICAgdGhpcy5zdG9wRGlzY292ZXJ5KCk7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgb25VbmxvYWQoKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcImluZGV4OiBvblVubG9hZFwiKTtcclxuXHJcbiAgICAvLyDlhbPpl63ok53niZnmqKHlnZdcclxuICAgIHRoaXMuY2xvc2VBZGFwdGVyKCk7XHJcbiAgfSxcclxuXHJcbiAgb25QdWxsRG93blJlZnJlc2goKSB7XHJcbiAgICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgICBkYXRhW1wiZGV2aWNlc1wiXSA9IFtdO1xyXG4gICAgdGhpcy5zZXREYXRhKGRhdGEpO1xyXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpO1xyXG5cclxuICAgIC8vIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgLy8gICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgICAvLyAgIGRhdGFbXCJkZXZpY2VzXCJdID0gb2JqO1xyXG4gICAgLy8gICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgICAvLyB9LCA1MDAwKTtcclxuICB9LFxyXG5cclxuICBvblRhcERldmljZShlOiBhbnkpIHtcclxuICAgIGNvbnN0IGk6IG51bWJlciA9IGUuY3VycmVudFRhcmdldC5pZDtcclxuICAgIGNvbnN0IGRldmljZSA9IHRoaXMuZGF0YS5kZXZpY2VzW2ldO1xyXG4gICAgY29uc3Qgb3B0aW9uOiBXZWNoYXRNaW5pcHJvZ3JhbS5OYXZpZ2F0ZVRvT3B0aW9uID0ge1xyXG4gICAgICB1cmw6IFwiLi4vZGV2aWNlL2RldmljZVwiLFxyXG4gICAgICBzdWNjZXNzOiByZXMgPT4gcmVzLmV2ZW50Q2hhbm5lbC5lbWl0KFwiZGV2aWNlXCIsIGRldmljZSlcclxuICAgIH07XHJcbiAgICB3eC5uYXZpZ2F0ZVRvKG9wdGlvbik7XHJcbiAgfSxcclxuXHJcbiAgb25BZGFwdGVyU3RhdGVDaGFuZ2UocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5PbkJsdWV0b290aEFkYXB0ZXJTdGF0ZUNoYW5nZUNhbGxiYWNrUmVzdWx0KSB7XHJcbiAgICBjb25zb2xlLmxvZyhg6JOd54mZ6YCC6YWN5Zmo54q25oCB5pS55Y+Y77yaJHtyZXMuYXZhaWxhYmxlfSAtICR7cmVzLmRpc2NvdmVyaW5nfWApO1xyXG5cclxuICAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7XHJcbiAgICAgIFwiYXZhaWxhYmxlXCI6IHJlcy5hdmFpbGFibGUsXHJcbiAgICAgIFwiZGlzY292ZXJpbmdcIjogcmVzLmRpc2NvdmVyaW5nXHJcbiAgICB9O1xyXG4gICAgdGhpcy5zZXREYXRhKGRhdGEpO1xyXG5cclxuICAgIGlmIChyZXMuYXZhaWxhYmxlKSB7XHJcbiAgICAgIGlmIChoaWRlICYmIHJlcy5kaXNjb3ZlcmluZykge1xyXG4gICAgICAgIHRoaXMuc3RvcERpc2NvdmVyeSgpO1xyXG4gICAgICB9IGVsc2UgaWYgKCFoaWRlICYmICFyZXMuZGlzY292ZXJpbmcpIHtcclxuICAgICAgICB0aGlzLnN0YXJ0RGlzY292ZXJ5KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9LFxyXG5cclxuICBvbkRldmljZUZvdW5kKHJlczogV2VjaGF0TWluaXByb2dyYW0uT25CbHVldG9vdGhEZXZpY2VGb3VuZENhbGxiYWNrUmVzdWx0KSB7XHJcbiAgICByZXMuZGV2aWNlcy5mb3JFYWNoKGRldmljZSA9PiB7XHJcbiAgICAgIGNvbnN0IGRhdGE6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fTtcclxuICAgICAgY29uc3QgaSA9IGluQXJyYXkodGhpcy5kYXRhLmRldmljZXMsICdkZXZpY2VJZCcsIGRldmljZS5kZXZpY2VJZCk7XHJcbiAgICAgIGlmIChpID09PSAtMSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGDlj5HnjrDorr7lpIfvvJoke0pTT04uc3RyaW5naWZ5KGRldmljZSl9YCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuZGF0YS5kZXZpY2VzLmxlbmd0aDtcclxuICAgICAgICBkYXRhW2BkZXZpY2VzWyR7bGVuZ3RofV1gXSA9IGRldmljZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkYXRhW2BkZXZpY2VzWyR7aX1dYF0gPSBkZXZpY2U7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zZXREYXRhKGRhdGEpO1xyXG4gICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgb3BlbkFkYXB0ZXIoKSB7XHJcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLk9wZW5CbHVldG9vdGhBZGFwdGVyT3B0aW9uID0ge1xyXG4gICAgICBzdWNjZXNzOiAoKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCLmiZPlvIDok53niZnmqKHlnZfmiJDlip9cIik7XHJcblxyXG4gICAgICAgIHRoaXMub25BZGFwdGVyT3BlbigpO1xyXG4gICAgICB9LFxyXG4gICAgICBmYWlsOiByZXMgPT4gY29uc29sZS5sb2coYOaJk+W8gOiTneeJmeaooeWdl+Wksei0pe+8miR7cmVzLmVyckNvZGV9IC0gJHtyZXMuZXJyTXNnfWApXHJcbiAgICB9O1xyXG4gICAgd3gub3BlbkJsdWV0b290aEFkYXB0ZXIob3B0aW9uKTtcclxuICB9LFxyXG5cclxuICBvbkFkYXB0ZXJPcGVuKCkge1xyXG4gICAgY29uc3Qgb3B0aW9uMTogV2VjaGF0TWluaXByb2dyYW0uR2V0Qmx1ZXRvb3RoQWRhcHRlclN0YXRlT3B0aW9uID0ge1xyXG4gICAgICBzdWNjZXNzOiByZXMgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGDojrflj5bok53niZnpgILphY3lmajnirbmgIHmiJDlip/vvJoke3Jlcy5hdmFpbGFibGV9IC0gJHtyZXMuZGlzY292ZXJpbmd9YCk7XHJcblxyXG4gICAgICAgIHRoaXMub25BZGFwdGVyU3RhdGVDaGFuZ2UocmVzKTtcclxuICAgICAgfSxcclxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDojrflj5bok53niZnpgILphY3lmajnirbmgIHlpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxyXG4gICAgfTtcclxuICAgIHd4LmdldEJsdWV0b290aEFkYXB0ZXJTdGF0ZShvcHRpb24xKTtcclxuICB9LFxyXG5cclxuICBjbG9zZUFkYXB0ZXIoKSB7XHJcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLkNsb3NlQmx1ZXRvb3RoQWRhcHRlck9wdGlvbiA9IHtcclxuICAgICAgc3VjY2VzczogKCkgPT4gY29uc29sZS5sb2coXCLlhbPpl63ok53niZnmqKHlnZfmiJDlip9cIiksXHJcbiAgICAgIGZhaWw6IHJlcyA9PiBjb25zb2xlLmxvZyhg5YWz6Zet6JOd54mZ5qih5Z2X5aSx6LSl77yaJHtyZXMuZXJyQ29kZX0gLSAke3Jlcy5lcnJNc2d9YClcclxuICAgIH07XHJcbiAgICB3eC5jbG9zZUJsdWV0b290aEFkYXB0ZXIob3B0aW9uKTtcclxuICB9LFxyXG5cclxuICBzdGFydERpc2NvdmVyeSgpIHtcclxuICAgIGNvbnN0IG9wdGlvbjogV2VjaGF0TWluaXByb2dyYW0uU3RhcnRCbHVldG9vdGhEZXZpY2VzRGlzY292ZXJ5T3B0aW9uID0ge1xyXG4gICAgICBhbGxvd0R1cGxpY2F0ZXNLZXk6IHRydWUsXHJcbiAgICAgIHNlcnZpY2VzOiBbc2VydmljZUlkXSxcclxuICAgICAgc3VjY2VzczogKCkgPT4gY29uc29sZS5sb2coXCLlvIDlp4vmiavmj4/miJDlip9cIiksXHJcbiAgICAgIGZhaWw6IHJlcyA9PiBjb25zb2xlLmxvZyhg5byA5aeL5omr5o+P5aSx6LSl77yaJHtyZXMuZXJyQ29kZX0gLSAke3Jlcy5lcnJNc2d9YClcclxuICAgIH1cclxuICAgIHd4LnN0YXJ0Qmx1ZXRvb3RoRGV2aWNlc0Rpc2NvdmVyeShvcHRpb24pO1xyXG4gIH0sXHJcblxyXG4gIHN0b3BEaXNjb3ZlcnkoKSB7XHJcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLlN0b3BCbHVldG9vdGhEZXZpY2VzRGlzY292ZXJ5T3B0aW9uID0ge1xyXG4gICAgICBzdWNjZXNzOiAoKSA9PiBjb25zb2xlLmxvZyhcIuWBnOatouaJq+aPj+aIkOWKn1wiKSxcclxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDlgZzmraLmiavmj4/lpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxyXG4gICAgfTtcclxuICAgIHd4LnN0b3BCbHVldG9vdGhEZXZpY2VzRGlzY292ZXJ5KG9wdGlvbik7XHJcbiAgfVxyXG59KTsiXX0=