"use strict";
var serviceId = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
function inArray(arr, key, val) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i][key] === val) {
            return i;
        }
    }
    return -1;
}
var obj = [];
var hide = false;
Page({
    data: {
        available: false,
        discovering: false,
        devices: obj
    },
    onLoad: function () {
        var _this = this;
        console.log("index: onLoad");
        wx.onBluetoothAdapterStateChange(function (res) { return _this.onAdapterStateChange(res); });
        wx.onBluetoothDeviceFound(function (res) { return _this.onDeviceFound(res); });
        this.openAdapter();
    },
    onReady: function () {
        console.log("index: onReady");
    },
    onShow: function () {
        console.log("index: onShow");
        hide = false;
        if (this.data.available && !this.data.discovering) {
            this.startDiscovery();
        }
    },
    onHide: function () {
        console.log("index: onHide");
        hide = true;
        if (this.data.available && this.data.discovering) {
            this.stopDiscovery();
        }
    },
    onUnload: function () {
        console.log("index: onUnload");
        this.closeAdapter();
    },
    onPullDownRefresh: function () {
        var data = {};
        data["devices"] = [];
        this.setData(data);
        wx.stopPullDownRefresh();
    },
    onTapDevice: function (e) {
        var i = e.currentTarget.id;
        var device = this.data.devices[i];
        var option = {
            url: "../device/device",
            success: function (res) { return res.eventChannel.emit("device", device); }
        };
        wx.navigateTo(option);
    },
    onAdapterStateChange: function (res) {
        console.log("\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u6539\u53D8\uFF1A" + res.available + " - " + res.discovering);
        var data = {
            "available": res.available,
            "discovering": res.discovering
        };
        this.setData(data);
        if (res.available) {
            if (hide && res.discovering) {
                this.stopDiscovery();
            }
            else if (!hide && !res.discovering) {
                this.startDiscovery();
            }
        }
    },
    onDeviceFound: function (res) {
        var _this = this;
        res.devices.forEach(function (device) {
            var data = {};
            var i = inArray(_this.data.devices, 'deviceId', device.deviceId);
            if (i === -1) {
                console.log("\u53D1\u73B0\u8BBE\u5907\uFF1A" + JSON.stringify(device));
                var length = _this.data.devices.length;
                data["devices[" + length + "]"] = device;
            }
            else {
                data["devices[" + i + "]"] = device;
            }
            _this.setData(data);
        });
    },
    openAdapter: function () {
        var _this = this;
        var option = {
            success: function () {
                console.log("打开蓝牙模块成功");
                _this.onAdapterOpen();
            },
            fail: function (res) { return console.log("\u6253\u5F00\u84DD\u7259\u6A21\u5757\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.openBluetoothAdapter(option);
    },
    onAdapterOpen: function () {
        var _this = this;
        var option1 = {
            success: function (res) {
                console.log("\u83B7\u53D6\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u6210\u529F\uFF1A" + res.available + " - " + res.discovering);
                _this.onAdapterStateChange(res);
            },
            fail: function (res) { return console.log("\u83B7\u53D6\u84DD\u7259\u9002\u914D\u5668\u72B6\u6001\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.getBluetoothAdapterState(option1);
    },
    closeAdapter: function () {
        var option = {
            success: function () { return console.log("关闭蓝牙模块成功"); },
            fail: function (res) { return console.log("\u5173\u95ED\u84DD\u7259\u6A21\u5757\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.closeBluetoothAdapter(option);
    },
    startDiscovery: function () {
        var option = {
            allowDuplicatesKey: true,
            services: [serviceId],
            success: function () { return console.log("开始扫描成功"); },
            fail: function (res) { return console.log("\u5F00\u59CB\u626B\u63CF\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.startBluetoothDevicesDiscovery(option);
    },
    stopDiscovery: function () {
        var option = {
            success: function () { return console.log("停止扫描成功"); },
            fail: function (res) { return console.log("\u505C\u6B62\u626B\u63CF\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.stopBluetoothDevicesDiscovery(option);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsSUFBTSxTQUFTLEdBQVcsc0NBQXNDLENBQUM7QUFFakUsU0FBUyxPQUFPLENBQUMsR0FBbUIsRUFBRSxHQUFvQixFQUFFLEdBQVE7SUFDbEUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDbkMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3ZCLE9BQU8sQ0FBQyxDQUFDO1NBQ1Y7S0FDRjtJQUNELE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDWixDQUFDO0FBRUQsSUFBTSxHQUFHLEdBQXNELEVBVTlELENBQUM7QUFFRixJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7QUFFakIsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osU0FBUyxFQUFFLEtBQUs7UUFDaEIsV0FBVyxFQUFFLEtBQUs7UUFDbEIsT0FBTyxFQUFFLEdBQUc7S0FDYjtJQVFELE1BQU07UUFBTixpQkFPQztRQU5DLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFN0IsRUFBRSxDQUFDLDZCQUE2QixDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxFQUE5QixDQUE4QixDQUFDLENBQUM7UUFDeEUsRUFBRSxDQUFDLHNCQUFzQixDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBdkIsQ0FBdUIsQ0FBQyxDQUFDO1FBRTFELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJ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QUFDO0NBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW5kZXgudHNcbmNvbnN0IHNlcnZpY2VJZDogc3RyaW5nID0gXCI2RTQwMDAwMS1CNUEzLUYzOTMtRTBBOS1FNTBFMjREQ0NBOUVcIjtcblxuZnVuY3Rpb24gaW5BcnJheShhcnI6IHN0cmluZyB8IGFueVtdLCBrZXk6IHN0cmluZyB8IG51bWJlciwgdmFsOiBhbnkpIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAoYXJyW2ldW2tleV0gPT09IHZhbCkge1xuICAgICAgcmV0dXJuIGk7XG4gICAgfVxuICB9XG4gIHJldHVybiAtMTtcbn1cblxuY29uc3Qgb2JqOiBXZWNoYXRNaW5pcHJvZ3JhbS5DYWxsYmFja1Jlc3VsdEJsdWVUb290aERldmljZVtdID0gW1xuICAvLyB7XG4gIC8vICAgYWR2ZXJ0aXNEYXRhOiBuZXcgQXJyYXlCdWZmZXIoMCksXG4gIC8vICAgYWR2ZXJ0aXNTZXJ2aWNlVVVJRHM6IFtdLFxuICAvLyAgIHNlcnZpY2VEYXRhOiB7fSxcbiAgLy8gICBkZXZpY2VJZDogXCJBQTg2NzMwRC1DNjUxLTRBM0UtQUI0MC1DMUM3QTNFQkNFOUZcIixcbiAgLy8gICBuYW1lOiBcIlRFU1QgMDFcIixcbiAgLy8gICBsb2NhbE5hbWU6IFwiV2UgVGVzdFwiLFxuICAvLyAgIFJTU0k6IC01OVxuICAvLyB9XG5dO1xuXG5sZXQgaGlkZSA9IGZhbHNlO1xuXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIGF2YWlsYWJsZTogZmFsc2UsXG4gICAgZGlzY292ZXJpbmc6IGZhbHNlLFxuICAgIGRldmljZXM6IG9ialxuICB9LFxuXG4gIC8vIG9uVGVzdCgpIHtcbiAgLy8gICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gIC8vICAgZGF0YVtcImF2YWlsYWJsZVwiXSA9ICF0aGlzLmRhdGEuYXZhaWxhYmxlO1xuICAvLyAgIHRoaXMuc2V0RGF0YShkYXRhKTtcbiAgLy8gfSxcblxuICBvbkxvYWQoKSB7XG4gICAgY29uc29sZS5sb2coXCJpbmRleDogb25Mb2FkXCIpO1xuXG4gICAgd3gub25CbHVldG9vdGhBZGFwdGVyU3RhdGVDaGFuZ2UocmVzID0+IHRoaXMub25BZGFwdGVyU3RhdGVDaGFuZ2UocmVzKSk7XG4gICAgd3gub25CbHVldG9vdGhEZXZpY2VGb3VuZChyZXMgPT4gdGhpcy5vbkRldmljZUZvdW5kKHJlcykpO1xuICAgIC8vIOWIneWni+WMluiTneeJmeaooeWdl1xuICAgIHRoaXMub3BlbkFkYXB0ZXIoKTtcbiAgfSxcblxuICBvblJlYWR5KCkge1xuICAgIGNvbnNvbGUubG9nKFwiaW5kZXg6IG9uUmVhZHlcIik7XG5cbiAgfSxcblxuICBvblNob3coKSB7XG4gICAgY29uc29sZS5sb2coXCJpbmRleDogb25TaG93XCIpO1xuXG4gICAgaGlkZSA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmRhdGEuYXZhaWxhYmxlICYmICF0aGlzLmRhdGEuZGlzY292ZXJpbmcpIHtcbiAgICAgIHRoaXMuc3RhcnREaXNjb3ZlcnkoKTtcbiAgICB9XG4gIH0sXG5cbiAgb25IaWRlKCkge1xuICAgIGNvbnNvbGUubG9nKFwiaW5kZXg6IG9uSGlkZVwiKTtcblxuICAgIGhpZGUgPSB0cnVlO1xuICAgIGlmICh0aGlzLmRhdGEuYXZhaWxhYmxlICYmIHRoaXMuZGF0YS5kaXNjb3ZlcmluZykge1xuICAgICAgdGhpcy5zdG9wRGlzY292ZXJ5KCk7XG4gICAgfVxuICB9LFxuXG4gIG9uVW5sb2FkKCkge1xuICAgIGNvbnNvbGUubG9nKFwiaW5kZXg6IG9uVW5sb2FkXCIpO1xuXG4gICAgLy8g5YWz6Zet6JOd54mZ5qih5Z2XXG4gICAgdGhpcy5jbG9zZUFkYXB0ZXIoKTtcbiAgfSxcblxuICBvblB1bGxEb3duUmVmcmVzaCgpIHtcbiAgICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgZGF0YVtcImRldmljZXNcIl0gPSBbXTtcbiAgICB0aGlzLnNldERhdGEoZGF0YSk7XG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpO1xuXG4gICAgLy8gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgLy8gICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgLy8gICBkYXRhW1wiZGV2aWNlc1wiXSA9IG9iajtcbiAgICAvLyAgIHRoaXMuc2V0RGF0YShkYXRhKTtcbiAgICAvLyB9LCA1MDAwKTtcbiAgfSxcblxuICBvblRhcERldmljZShlOiBhbnkpIHtcbiAgICBjb25zdCBpOiBudW1iZXIgPSBlLmN1cnJlbnRUYXJnZXQuaWQ7XG4gICAgY29uc3QgZGV2aWNlID0gdGhpcy5kYXRhLmRldmljZXNbaV07XG4gICAgY29uc3Qgb3B0aW9uOiBXZWNoYXRNaW5pcHJvZ3JhbS5OYXZpZ2F0ZVRvT3B0aW9uID0ge1xuICAgICAgdXJsOiBcIi4uL2RldmljZS9kZXZpY2VcIixcbiAgICAgIHN1Y2Nlc3M6IHJlcyA9PiByZXMuZXZlbnRDaGFubmVsLmVtaXQoXCJkZXZpY2VcIiwgZGV2aWNlKVxuICAgIH07XG4gICAgd3gubmF2aWdhdGVUbyhvcHRpb24pO1xuICB9LFxuXG4gIG9uQWRhcHRlclN0YXRlQ2hhbmdlKHJlczogV2VjaGF0TWluaXByb2dyYW0uT25CbHVldG9vdGhBZGFwdGVyU3RhdGVDaGFuZ2VDYWxsYmFja1Jlc3VsdCkge1xuICAgIGNvbnNvbGUubG9nKGDok53niZnpgILphY3lmajnirbmgIHmlLnlj5jvvJoke3Jlcy5hdmFpbGFibGV9IC0gJHtyZXMuZGlzY292ZXJpbmd9YCk7XG5cbiAgICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICAgXCJhdmFpbGFibGVcIjogcmVzLmF2YWlsYWJsZSxcbiAgICAgIFwiZGlzY292ZXJpbmdcIjogcmVzLmRpc2NvdmVyaW5nXG4gICAgfTtcbiAgICB0aGlzLnNldERhdGEoZGF0YSk7XG5cbiAgICBpZiAocmVzLmF2YWlsYWJsZSkge1xuICAgICAgaWYgKGhpZGUgJiYgcmVzLmRpc2NvdmVyaW5nKSB7XG4gICAgICAgIHRoaXMuc3RvcERpc2NvdmVyeSgpO1xuICAgICAgfSBlbHNlIGlmICghaGlkZSAmJiAhcmVzLmRpc2NvdmVyaW5nKSB7XG4gICAgICAgIHRoaXMuc3RhcnREaXNjb3ZlcnkoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgb25EZXZpY2VGb3VuZChyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLk9uQmx1ZXRvb3RoRGV2aWNlRm91bmRDYWxsYmFja1Jlc3VsdCkge1xuICAgIHJlcy5kZXZpY2VzLmZvckVhY2goZGV2aWNlID0+IHtcbiAgICAgIGNvbnN0IGRhdGE6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fTtcbiAgICAgIGNvbnN0IGkgPSBpbkFycmF5KHRoaXMuZGF0YS5kZXZpY2VzLCAnZGV2aWNlSWQnLCBkZXZpY2UuZGV2aWNlSWQpO1xuICAgICAgaWYgKGkgPT09IC0xKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDlj5HnjrDorr7lpIfvvJoke0pTT04uc3RyaW5naWZ5KGRldmljZSl9YCk7XG5cbiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5kYXRhLmRldmljZXMubGVuZ3RoO1xuICAgICAgICBkYXRhW2BkZXZpY2VzWyR7bGVuZ3RofV1gXSA9IGRldmljZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGFbYGRldmljZXNbJHtpfV1gXSA9IGRldmljZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0RGF0YShkYXRhKTtcbiAgICB9KTtcbiAgfSxcblxuICBvcGVuQWRhcHRlcigpIHtcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLk9wZW5CbHVldG9vdGhBZGFwdGVyT3B0aW9uID0ge1xuICAgICAgc3VjY2VzczogKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcIuaJk+W8gOiTneeJmeaooeWdl+aIkOWKn1wiKTtcblxuICAgICAgICB0aGlzLm9uQWRhcHRlck9wZW4oKTtcbiAgICAgIH0sXG4gICAgICBmYWlsOiByZXMgPT4gY29uc29sZS5sb2coYOaJk+W8gOiTneeJmeaooeWdl+Wksei0pe+8miR7cmVzLmVyckNvZGV9IC0gJHtyZXMuZXJyTXNnfWApXG4gICAgfTtcbiAgICB3eC5vcGVuQmx1ZXRvb3RoQWRhcHRlcihvcHRpb24pO1xuICB9LFxuXG4gIG9uQWRhcHRlck9wZW4oKSB7XG4gICAgY29uc3Qgb3B0aW9uMTogV2VjaGF0TWluaXByb2dyYW0uR2V0Qmx1ZXRvb3RoQWRhcHRlclN0YXRlT3B0aW9uID0ge1xuICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coYOiOt+WPluiTneeJmemAgumFjeWZqOeKtuaAgeaIkOWKn++8miR7cmVzLmF2YWlsYWJsZX0gLSAke3Jlcy5kaXNjb3ZlcmluZ31gKTtcblxuICAgICAgICB0aGlzLm9uQWRhcHRlclN0YXRlQ2hhbmdlKHJlcyk7XG4gICAgICB9LFxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDojrflj5bok53niZnpgILphY3lmajnirbmgIHlpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxuICAgIH07XG4gICAgd3guZ2V0Qmx1ZXRvb3RoQWRhcHRlclN0YXRlKG9wdGlvbjEpO1xuICB9LFxuXG4gIGNsb3NlQWRhcHRlcigpIHtcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLkNsb3NlQmx1ZXRvb3RoQWRhcHRlck9wdGlvbiA9IHtcbiAgICAgIHN1Y2Nlc3M6ICgpID0+IGNvbnNvbGUubG9nKFwi5YWz6Zet6JOd54mZ5qih5Z2X5oiQ5YqfXCIpLFxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDlhbPpl63ok53niZnmqKHlnZflpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxuICAgIH07XG4gICAgd3guY2xvc2VCbHVldG9vdGhBZGFwdGVyKG9wdGlvbik7XG4gIH0sXG5cbiAgc3RhcnREaXNjb3ZlcnkoKSB7XG4gICAgY29uc3Qgb3B0aW9uOiBXZWNoYXRNaW5pcHJvZ3JhbS5TdGFydEJsdWV0b290aERldmljZXNEaXNjb3ZlcnlPcHRpb24gPSB7XG4gICAgICBhbGxvd0R1cGxpY2F0ZXNLZXk6IHRydWUsXG4gICAgICBzZXJ2aWNlczogW3NlcnZpY2VJZF0sXG4gICAgICBzdWNjZXNzOiAoKSA9PiBjb25zb2xlLmxvZyhcIuW8gOWni+aJq+aPj+aIkOWKn1wiKSxcbiAgICAgIGZhaWw6IHJlcyA9PiBjb25zb2xlLmxvZyhg5byA5aeL5omr5o+P5aSx6LSl77yaJHtyZXMuZXJyQ29kZX0gLSAke3Jlcy5lcnJNc2d9YClcbiAgICB9XG4gICAgd3guc3RhcnRCbHVldG9vdGhEZXZpY2VzRGlzY292ZXJ5KG9wdGlvbik7XG4gIH0sXG5cbiAgc3RvcERpc2NvdmVyeSgpIHtcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLlN0b3BCbHVldG9vdGhEZXZpY2VzRGlzY292ZXJ5T3B0aW9uID0ge1xuICAgICAgc3VjY2VzczogKCkgPT4gY29uc29sZS5sb2coXCLlgZzmraLmiavmj4/miJDlip9cIiksXG4gICAgICBmYWlsOiByZXMgPT4gY29uc29sZS5sb2coYOWBnOatouaJq+aPj+Wksei0pe+8miR7cmVzLmVyckNvZGV9IC0gJHtyZXMuZXJyTXNnfWApXG4gICAgfTtcbiAgICB3eC5zdG9wQmx1ZXRvb3RoRGV2aWNlc0Rpc2NvdmVyeShvcHRpb24pO1xuICB9XG59KTsiXX0=