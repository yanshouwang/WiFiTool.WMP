"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var encodeUtf8 = require("encode-utf8");
var decodeUtf8 = require("decode-utf8");
var serviceId = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
var notifyCharacteristicId = "6E400003-B5A3-F393-E0A9-E50E24DCCA9E";
var writeCharacteristicId = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E";
var getStatusCmd = "GET STUTAS";
var modifyCmd = "MODIFY";
var keepAliveCmd = "KEEP ALIVE";
var endSymbol = "\r\n";
var ethernet = "ethernet";
var wifi = "wifi";
var obj1 = {
    advertisData: new ArrayBuffer(0),
    advertisServiceUUIDs: [],
    serviceData: [],
    deviceId: "",
    RSSI: 0,
    name: "",
    localName: ""
};
var intervalID = -1;
var hide = false;
var unload = false;
Page({
    data: {
        device: obj1,
        connected: true,
        adapters: [
            {
                type: ethernet,
                connected: false
            },
            {
                type: wifi,
                connected: false
            }
        ]
    },
    onLoad: function () {
        var _this = this;
        console.log("device: onLoad");
        wx.onBLEConnectionStateChange(function (res) { return _this.onConnectionStateChange(res); });
        wx.onBLECharacteristicValueChange(function (res) { return _this.onCharacteristicValueChange(res); });
        var eventChannel = this.getOpenerEventChannel();
        eventChannel.on("device", function (device) { return _this.onLoadDevice(device); });
    },
    onReady: function () {
        console.log("device: onReady");
    },
    onShow: function () {
        console.log("device: onShow");
        hide = false;
        if (!this.data.connected) {
            this.connect();
        }
    },
    onHide: function () {
        console.log("device: onHide");
        hide = true;
    },
    onUnload: function () {
        console.log("device: onUnload");
        unload = true;
        this.disconnect();
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
    onShareAppMessage: function (opts) {
        console.log(opts.target);
        return {};
    },
    onLoadDevice: function (device) {
        var data = { "device": device };
        this.setData(data);
        this.connect();
    },
    onTapAdapter: function (e) {
        var device = this.data.device;
        var i = e.currentTarget.id;
        var adapter = this.data.adapters[i];
        var option = {
            url: "../adapter/adapter",
            success: function (res) { return res.eventChannel.emit("adapter", device, adapter); }
        };
        wx.navigateTo(option);
    },
    onConnectionStateChange: function (res) {
        var _this = this;
        var device = this.data.device;
        if (res.deviceId !== device.deviceId) {
            return;
        }
        var connected = res.connected;
        var data = { "connected": connected };
        this.setData(data);
        console.log("\u8FDE\u63A5\u72B6\u6001\u6539\u53D8\uFF1A" + connected);
        if (connected) {
            var option1 = {
                deviceId: device.deviceId,
                success: function () {
                    var option2 = {
                        deviceId: device.deviceId,
                        serviceId: serviceId,
                        success: function () {
                            var option3 = {
                                deviceId: device.deviceId,
                                serviceId: serviceId,
                                characteristicId: notifyCharacteristicId,
                                state: true,
                                success: function () {
                                    _this.keepAlive();
                                    _this.getStatus();
                                },
                                fail: function (res) { return console.log("\u6253\u5F00\u901A\u77E5\u5931\u8D25\uFF1A " + res.errCode + " - " + res.errMsg); }
                            };
                            wx.notifyBLECharacteristicValueChange(option3);
                        },
                        fail: function (res) { return console.log("\u83B7\u53D6\u7279\u5F81\u503C\u5931\u8D25\uFF1A " + res.errCode + " - " + res.errMsg); }
                    };
                    wx.getBLEDeviceCharacteristics(option2);
                },
                fail: function (res) { return console.log("\u83B7\u53D6\u670D\u52A1\u5931\u8D25\uFF1A " + res.errCode + " - " + res.errMsg); }
            };
            wx.getBLEDeviceServices(option1);
        }
        else {
            clearInterval(intervalID);
            if (!hide && !unload) {
                this.connect();
            }
        }
    },
    onCharacteristicValueChange: function (res) {
        console.log("特征值改变");
        var device = this.data.device;
        if (res.deviceId !== device.deviceId || res.serviceId !== serviceId || res.characteristicId !== notifyCharacteristicId) {
            return;
        }
        var str = decodeUtf8(res.value).trim();
        console.log(str);
        var value = JSON.parse(str);
        var cmd = value.cmd;
        switch (cmd) {
            case getStatusCmd:
            case modifyCmd: {
                var obj_1 = {
                    ssid: value.ssid,
                    address: value.address,
                    mask: value.mask,
                    gateway: value.gateway,
                    dns: value.dns
                };
                var data = {};
                switch (value.mode) {
                    case "ethernet": {
                        data["ethernet"] = obj_1;
                        data["wifi"] = {};
                        break;
                    }
                    case "wifi": {
                        data["ethernet"] = {};
                        data["wifi"] = obj_1;
                        break;
                    }
                    case "none": {
                        data["ethernet"] = {};
                        data["ethernet"] = {};
                        break;
                    }
                    default: {
                        break;
                    }
                }
                this.setData(data);
                wx.hideLoading();
                break;
            }
            default: {
                break;
            }
        }
    },
    onValuesChange: function (e) {
        var key = e.currentTarget.dataset.key;
        var value = e.detail.value;
        var data = {};
        data[key] = value;
        this.setData(data);
    },
    onIPChange: function (e) {
        var key = e.currentTarget.dataset.key;
        var value = e.detail.value;
        var data = {};
        data["ip." + key] = value;
        this.setData(data);
    },
    onDNSChange: function (e) {
        var key = e.currentTarget.dataset.key;
        var value = e.detail.value;
        var data = {};
        data["dns." + key] = value;
        this.setData(data);
    },
    connect: function () {
        var connected = this.data.connected;
        if (connected) {
            return;
        }
        var device = this.data.device;
        var option = {
            deviceId: device.deviceId,
            success: function () { return console.log("\u8FDE\u63A5\u6210\u529F"); },
            fail: function (res) { return console.log("\u8FDE\u63A5\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.createBLEConnection(option);
        this.showLoading("正在连接");
    },
    disconnect: function () {
        var connected = this.data.connected;
        if (!connected) {
            return;
        }
        var device = this.data.device;
        var option = {
            deviceId: device.deviceId,
            success: function () { return console.log("\u65AD\u5F00\u6210\u529F"); },
            fail: function (res) { return console.log("\u65AD\u5F00\u5931\u8D25\uFF1A" + res.errCode + " - " + res.errMsg); }
        };
        wx.closeBLEConnection(option);
    },
    write: function (str) {
        str = "" + str + endSymbol;
        var device = this.data.device;
        var value = encodeUtf8(str);
        var option2 = {
            deviceId: device.deviceId,
            serviceId: serviceId,
            characteristicId: writeCharacteristicId,
            value: value,
            success: function () { return console.log("\u5199\u5165\u6210\u529F\uFF1A" + str); },
            fail: function (res) { return console.log("\u5199\u5165\u5931\u8D25\uFF1A " + res.errCode + " - " + res.errMsg); }
        };
        wx.writeBLECharacteristicValue(option2);
    },
    keepAlive: function () {
        var _this = this;
        var value = {
            cmd: keepAliveCmd
        };
        var str = JSON.stringify(value);
        intervalID = setInterval(function () { return _this.write(str); }, 20 * 1000);
    },
    getStatus: function () {
        var value = {
            cmd: getStatusCmd
        };
        var str = JSON.stringify(value);
        this.write(str);
    },
    modify: function (mode, address, mask, gateway, dns, ssid, password) {
        var value = {
            cmd: modifyCmd,
            mode: mode,
            ssid: ssid,
            password: password,
            address: address,
            mask: mask,
            gateway: gateway,
            dns: dns
        };
        var str = JSON.stringify(value);
        this.write(str);
        this.showLoading("正在配置网络");
    },
    showLoading: function (title) {
        var option = {
            title: title,
            mask: true
        };
        wx.showLoading(option);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGV2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsd0NBQTJDO0FBQzNDLHdDQUEyQztBQUUzQyxJQUFNLFNBQVMsR0FBVyxzQ0FBc0MsQ0FBQztBQUNqRSxJQUFNLHNCQUFzQixHQUFXLHNDQUFzQyxDQUFDO0FBQzlFLElBQU0scUJBQXFCLEdBQVcsc0NBQXNDLENBQUM7QUFDN0UsSUFBTSxZQUFZLEdBQVcsWUFBWSxDQUFDO0FBQzFDLElBQU0sU0FBUyxHQUFXLFFBQVEsQ0FBQztBQUNuQyxJQUFNLFlBQVksR0FBVyxZQUFZLENBQUM7QUFFMUMsSUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDO0FBRXpCLElBQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQztBQUM1QixJQUFNLElBQUksR0FBRyxNQUFNLENBQUM7QUFFcEIsSUFBTSxJQUFJLEdBQW9EO0lBQzVELFlBQVksRUFBRSxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFDaEMsb0JBQW9CLEVBQUUsRUFBRTtJQUN4QixXQUFXLEVBQUUsRUFBRTtJQUNmLFFBQVEsRUFBRSxFQUFFO0lBQ1osSUFBSSxFQUFFLENBQUM7SUFDUCxJQUFJLEVBQUUsRUFBRTtJQUNSLFNBQVMsRUFBRSxFQUFFO0NBQ2QsQ0FBQztBQUVGLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3BCLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQztBQUNqQixJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUM7QUFFbkIsSUFBSSxDQUFDO0lBSUgsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLElBQUk7UUFDWixTQUFTLEVBQUUsSUFBSTtRQUNmLFFBQVEsRUFBRTtZQUNSO2dCQUNFLElBQUksRUFBRSxRQUFRO2dCQUNkLFNBQVMsRUFBRSxLQUFLO2FBQ2pCO1lBQ0Q7Z0JBQ0UsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsU0FBUyxFQUFFLEtBQUs7YUFDakI7U0FD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QUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFRCxXQUFXLFlBQUMsS0FBYTtRQUN2QixJQUFNLE1BQU0sR0FBd0M7WUFDbEQsS0FBSyxFQUFFLEtBQUs7WUFDWixJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUM7UUFDRixFQUFFLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3pCLENBQUM7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZW5jb2RlVXRmOCA9IHJlcXVpcmUoXCJlbmNvZGUtdXRmOFwiKTtcclxuaW1wb3J0IGRlY29kZVV0ZjggPSByZXF1aXJlKFwiZGVjb2RlLXV0ZjhcIik7XHJcblxyXG5jb25zdCBzZXJ2aWNlSWQ6IHN0cmluZyA9IFwiNkU0MDAwMDEtQjVBMy1GMzkzLUUwQTktRTUwRTI0RENDQTlFXCI7XHJcbmNvbnN0IG5vdGlmeUNoYXJhY3RlcmlzdGljSWQ6IHN0cmluZyA9IFwiNkU0MDAwMDMtQjVBMy1GMzkzLUUwQTktRTUwRTI0RENDQTlFXCI7XHJcbmNvbnN0IHdyaXRlQ2hhcmFjdGVyaXN0aWNJZDogc3RyaW5nID0gXCI2RTQwMDAwMi1CNUEzLUYzOTMtRTBBOS1FNTBFMjREQ0NBOUVcIjtcclxuY29uc3QgZ2V0U3RhdHVzQ21kOiBzdHJpbmcgPSBcIkdFVCBTVFVUQVNcIjtcclxuY29uc3QgbW9kaWZ5Q21kOiBzdHJpbmcgPSBcIk1PRElGWVwiO1xyXG5jb25zdCBrZWVwQWxpdmVDbWQ6IHN0cmluZyA9IFwiS0VFUCBBTElWRVwiO1xyXG5cclxuY29uc3QgZW5kU3ltYm9sID0gXCJcXHJcXG5cIjtcclxuXHJcbmNvbnN0IGV0aGVybmV0ID0gXCJldGhlcm5ldFwiO1xyXG5jb25zdCB3aWZpID0gXCJ3aWZpXCI7XHJcblxyXG5jb25zdCBvYmoxOiBXZWNoYXRNaW5pcHJvZ3JhbS5DYWxsYmFja1Jlc3VsdEJsdWVUb290aERldmljZSA9IHtcclxuICBhZHZlcnRpc0RhdGE6IG5ldyBBcnJheUJ1ZmZlcigwKSxcclxuICBhZHZlcnRpc1NlcnZpY2VVVUlEczogW10sXHJcbiAgc2VydmljZURhdGE6IFtdLFxyXG4gIGRldmljZUlkOiBcIlwiLFxyXG4gIFJTU0k6IDAsXHJcbiAgbmFtZTogXCJcIixcclxuICBsb2NhbE5hbWU6IFwiXCJcclxufTtcclxuXHJcbmxldCBpbnRlcnZhbElEID0gLTE7XHJcbmxldCBoaWRlID0gZmFsc2U7XHJcbmxldCB1bmxvYWQgPSBmYWxzZTtcclxuXHJcblBhZ2Uoe1xyXG4gIC8qKlxyXG4gICAqIOmhtemdoueahOWIneWni+aVsOaNrlxyXG4gICAqL1xyXG4gIGRhdGE6IHtcclxuICAgIGRldmljZTogb2JqMSxcclxuICAgIGNvbm5lY3RlZDogdHJ1ZSxcclxuICAgIGFkYXB0ZXJzOiBbXHJcbiAgICAgIHtcclxuICAgICAgICB0eXBlOiBldGhlcm5ldCxcclxuICAgICAgICBjb25uZWN0ZWQ6IGZhbHNlXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICB0eXBlOiB3aWZpLFxyXG4gICAgICAgIGNvbm5lY3RlZDogZmFsc2VcclxuICAgICAgfVxyXG4gICAgXVxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yqg6L29XHJcbiAgICovXHJcbiAgb25Mb2FkKCkge1xyXG4gICAgY29uc29sZS5sb2coXCJkZXZpY2U6IG9uTG9hZFwiKTtcclxuXHJcbiAgICB3eC5vbkJMRUNvbm5lY3Rpb25TdGF0ZUNoYW5nZShyZXMgPT4gdGhpcy5vbkNvbm5lY3Rpb25TdGF0ZUNoYW5nZShyZXMpKTtcclxuICAgIHd4Lm9uQkxFQ2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZShyZXMgPT4gdGhpcy5vbkNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2UocmVzKSk7XHJcblxyXG4gICAgY29uc3QgZXZlbnRDaGFubmVsID0gdGhpcy5nZXRPcGVuZXJFdmVudENoYW5uZWwoKTtcclxuICAgIGV2ZW50Q2hhbm5lbC5vbihcImRldmljZVwiLCAoZGV2aWNlOiBXZWNoYXRNaW5pcHJvZ3JhbS5DYWxsYmFja1Jlc3VsdEJsdWVUb290aERldmljZSkgPT4gdGhpcy5vbkxvYWREZXZpY2UoZGV2aWNlKSk7XHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliJ3mrKHmuLLmn5PlrozmiJBcclxuICAgKi9cclxuICBvblJlYWR5KCkge1xyXG4gICAgY29uc29sZS5sb2coXCJkZXZpY2U6IG9uUmVhZHlcIik7XHJcblxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5pi+56S6XHJcbiAgICovXHJcbiAgb25TaG93KCkge1xyXG4gICAgY29uc29sZS5sb2coXCJkZXZpY2U6IG9uU2hvd1wiKTtcclxuXHJcbiAgICBoaWRlID0gZmFsc2U7XHJcbiAgICBpZiAoIXRoaXMuZGF0YS5jb25uZWN0ZWQpIHtcclxuICAgICAgdGhpcy5jb25uZWN0KCk7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLpmpDol49cclxuICAgKi9cclxuICBvbkhpZGUoKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcImRldmljZTogb25IaWRlXCIpO1xyXG5cclxuICAgIGhpZGUgPSB0cnVlO1xyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Y246L29XHJcbiAgICovXHJcbiAgb25VbmxvYWQoKSB7XHJcbiAgICBjb25zb2xlLmxvZyhcImRldmljZTogb25VbmxvYWRcIik7XHJcblxyXG4gICAgdW5sb2FkID0gdHJ1ZTtcclxuICAgIHRoaXMuZGlzY29ubmVjdCgpO1xyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXHJcbiAgICovXHJcbiAgb25QdWxsRG93blJlZnJlc2goKSB7XHJcblxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOmhtemdouS4iuaLieinpuW6leS6i+S7tueahOWkhOeQhuWHveaVsFxyXG4gICAqL1xyXG4gIG9uUmVhY2hCb3R0b20oKSB7XHJcblxyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIOeUqOaIt+eCueWHu+WPs+S4iuinkuWIhuS6q1xyXG4gICAqL1xyXG4gIG9uU2hhcmVBcHBNZXNzYWdlKG9wdHMpOiBXZWNoYXRNaW5pcHJvZ3JhbS5QYWdlLklDdXN0b21TaGFyZUNvbnRlbnQge1xyXG4gICAgY29uc29sZS5sb2cob3B0cy50YXJnZXQpXHJcbiAgICByZXR1cm4ge31cclxuICB9LFxyXG5cclxuICBvbkxvYWREZXZpY2UoZGV2aWNlOiBXZWNoYXRNaW5pcHJvZ3JhbS5DYWxsYmFja1Jlc3VsdEJsdWVUb290aERldmljZSkge1xyXG4gICAgY29uc3QgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PiA9IHsgXCJkZXZpY2VcIjogZGV2aWNlIH07XHJcbiAgICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgICB0aGlzLmNvbm5lY3QoKTtcclxuICB9LFxyXG5cclxuICBvblRhcEFkYXB0ZXIoZTogYW55KSB7XHJcbiAgICBjb25zdCBkZXZpY2UgPSB0aGlzLmRhdGEuZGV2aWNlO1xyXG4gICAgY29uc3QgaSA9IGUuY3VycmVudFRhcmdldC5pZDtcclxuICAgIGNvbnN0IGFkYXB0ZXIgPSB0aGlzLmRhdGEuYWRhcHRlcnNbaV07XHJcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLk5hdmlnYXRlVG9PcHRpb24gPSB7XHJcbiAgICAgIHVybDogXCIuLi9hZGFwdGVyL2FkYXB0ZXJcIixcclxuICAgICAgc3VjY2VzczogcmVzID0+IHJlcy5ldmVudENoYW5uZWwuZW1pdChcImFkYXB0ZXJcIiwgZGV2aWNlLCBhZGFwdGVyKVxyXG4gICAgfTtcclxuICAgIHd4Lm5hdmlnYXRlVG8ob3B0aW9uKTtcclxuICB9LFxyXG5cclxuICBvbkNvbm5lY3Rpb25TdGF0ZUNoYW5nZShyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLk9uQkxFQ29ubmVjdGlvblN0YXRlQ2hhbmdlQ2FsbGJhY2tSZXN1bHQpIHtcclxuICAgIGNvbnN0IGRldmljZSA9IHRoaXMuZGF0YS5kZXZpY2U7XHJcbiAgICBpZiAocmVzLmRldmljZUlkICE9PSBkZXZpY2UuZGV2aWNlSWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY29ubmVjdGVkOiBib29sZWFuID0gcmVzLmNvbm5lY3RlZDtcclxuICAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7IFwiY29ubmVjdGVkXCI6IGNvbm5lY3RlZCB9O1xyXG4gICAgdGhpcy5zZXREYXRhKGRhdGEpO1xyXG4gICAgY29uc29sZS5sb2coYOi/nuaOpeeKtuaAgeaUueWPmO+8miR7Y29ubmVjdGVkfWApO1xyXG4gICAgaWYgKGNvbm5lY3RlZCkge1xyXG4gICAgICAvLyDojrflj5bpgJrnn6XnibnlvoHlgLzvvIzmiZPlvIDpgJrnn6VcclxuICAgICAgLy8g6I635Y+W5YaZ5YWl54m55b6B5YC877yM5Y+R6YCB5oyH5LukXHJcbiAgICAgIGNvbnN0IG9wdGlvbjE6IFdlY2hhdE1pbmlwcm9ncmFtLkdldEJMRURldmljZVNlcnZpY2VzT3B0aW9uID0ge1xyXG4gICAgICAgIGRldmljZUlkOiBkZXZpY2UuZGV2aWNlSWQsXHJcbiAgICAgICAgc3VjY2VzczogKCkgPT4ge1xyXG4gICAgICAgICAgY29uc3Qgb3B0aW9uMjogV2VjaGF0TWluaXByb2dyYW0uR2V0QkxFRGV2aWNlQ2hhcmFjdGVyaXN0aWNzT3B0aW9uID0ge1xyXG4gICAgICAgICAgICBkZXZpY2VJZDogZGV2aWNlLmRldmljZUlkLFxyXG4gICAgICAgICAgICBzZXJ2aWNlSWQ6IHNlcnZpY2VJZCxcclxuICAgICAgICAgICAgc3VjY2VzczogKCkgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnN0IG9wdGlvbjM6IFdlY2hhdE1pbmlwcm9ncmFtLk5vdGlmeUJMRUNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2VPcHRpb24gPSB7XHJcbiAgICAgICAgICAgICAgICBkZXZpY2VJZDogZGV2aWNlLmRldmljZUlkLFxyXG4gICAgICAgICAgICAgICAgc2VydmljZUlkOiBzZXJ2aWNlSWQsXHJcbiAgICAgICAgICAgICAgICBjaGFyYWN0ZXJpc3RpY0lkOiBub3RpZnlDaGFyYWN0ZXJpc3RpY0lkLFxyXG4gICAgICAgICAgICAgICAgc3RhdGU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMua2VlcEFsaXZlKCk7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0U3RhdHVzKCk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDmiZPlvIDpgJrnn6XlpLHotKXvvJogJHtyZXMuZXJyQ29kZX0gLSAke3Jlcy5lcnJNc2d9YClcclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgIHd4Lm5vdGlmeUJMRUNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2Uob3B0aW9uMyk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZhaWw6IHJlcyA9PiBjb25zb2xlLmxvZyhg6I635Y+W54m55b6B5YC85aSx6LSl77yaICR7cmVzLmVyckNvZGV9IC0gJHtyZXMuZXJyTXNnfWApXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgd3guZ2V0QkxFRGV2aWNlQ2hhcmFjdGVyaXN0aWNzKG9wdGlvbjIpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDojrflj5bmnI3liqHlpLHotKXvvJogJHtyZXMuZXJyQ29kZX0gLSAke3Jlcy5lcnJNc2d9YClcclxuICAgICAgfTtcclxuICAgICAgd3guZ2V0QkxFRGV2aWNlU2VydmljZXMob3B0aW9uMSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDlgZzmraLlv4Pot7NcclxuICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElEKTtcclxuICAgICAgLy8g5byC5bi45pat5byA77yM5bCd6K+V6YeN5paw6L+e5o6lXHJcbiAgICAgIGlmICghaGlkZSAmJiAhdW5sb2FkKSB7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9LFxyXG5cclxuICBvbkNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2UocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5PbkJMRUNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2VDYWxsYmFja1Jlc3VsdCkge1xyXG4gICAgY29uc29sZS5sb2coXCLnibnlvoHlgLzmlLnlj5hcIik7XHJcblxyXG4gICAgY29uc3QgZGV2aWNlID0gdGhpcy5kYXRhLmRldmljZTtcclxuICAgIGlmIChyZXMuZGV2aWNlSWQgIT09IGRldmljZS5kZXZpY2VJZCB8fCByZXMuc2VydmljZUlkICE9PSBzZXJ2aWNlSWQgfHwgcmVzLmNoYXJhY3RlcmlzdGljSWQgIT09IG5vdGlmeUNoYXJhY3RlcmlzdGljSWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IHN0cjogc3RyaW5nID0gZGVjb2RlVXRmOChyZXMudmFsdWUpLnRyaW0oKTtcclxuICAgIGNvbnNvbGUubG9nKHN0cik7XHJcblxyXG4gICAgY29uc3QgdmFsdWU6IHsgW3N0cjogc3RyaW5nXTogYW55LCBjbWQ6IHN0cmluZywgZXJyQ29kZTogbnVtYmVyIH0gPSBKU09OLnBhcnNlKHN0cik7XHJcbiAgICBjb25zdCBjbWQgPSB2YWx1ZS5jbWQ7XHJcbiAgICBzd2l0Y2ggKGNtZCkge1xyXG4gICAgICBjYXNlIGdldFN0YXR1c0NtZDpcclxuICAgICAgY2FzZSBtb2RpZnlDbWQ6IHtcclxuICAgICAgICBjb25zdCBvYmogPSB7XHJcbiAgICAgICAgICBzc2lkOiB2YWx1ZS5zc2lkLFxyXG4gICAgICAgICAgYWRkcmVzczogdmFsdWUuYWRkcmVzcyxcclxuICAgICAgICAgIG1hc2s6IHZhbHVlLm1hc2ssXHJcbiAgICAgICAgICBnYXRld2F5OiB2YWx1ZS5nYXRld2F5LFxyXG4gICAgICAgICAgZG5zOiB2YWx1ZS5kbnNcclxuICAgICAgICB9O1xyXG4gICAgICAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuICAgICAgICBzd2l0Y2ggKHZhbHVlLm1vZGUpIHtcclxuICAgICAgICAgIGNhc2UgXCJldGhlcm5ldFwiOiB7XHJcbiAgICAgICAgICAgIGRhdGFbXCJldGhlcm5ldFwiXSA9IG9iajtcclxuICAgICAgICAgICAgZGF0YVtcIndpZmlcIl0gPSB7fTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjYXNlIFwid2lmaVwiOiB7XHJcbiAgICAgICAgICAgIGRhdGFbXCJldGhlcm5ldFwiXSA9IHt9O1xyXG4gICAgICAgICAgICBkYXRhW1wid2lmaVwiXSA9IG9iajtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjYXNlIFwibm9uZVwiOiB7XHJcbiAgICAgICAgICAgIGRhdGFbXCJldGhlcm5ldFwiXSA9IHt9O1xyXG4gICAgICAgICAgICBkYXRhW1wiZXRoZXJuZXRcIl0gPSB7fTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBkZWZhdWx0OiB7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgICBkZWZhdWx0OiB7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9LFxyXG5cclxuICBvblZhbHVlc0NoYW5nZShlOiBhbnkpIHtcclxuICAgIGNvbnN0IHsga2V5IH0gPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldDtcclxuICAgIGNvbnN0IHZhbHVlID0gZS5kZXRhaWwudmFsdWU7XHJcbiAgICBjb25zdCBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgICBkYXRhW2tleV0gPSB2YWx1ZTtcclxuICAgIHRoaXMuc2V0RGF0YShkYXRhKTtcclxuICB9LFxyXG5cclxuICBvbklQQ2hhbmdlKGU6IGFueSkge1xyXG4gICAgY29uc3QgeyBrZXkgfSA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0O1xyXG4gICAgY29uc3QgdmFsdWUgPSBlLmRldGFpbC52YWx1ZTtcclxuICAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuICAgIGRhdGFbYGlwLiR7a2V5fWBdID0gdmFsdWU7XHJcbiAgICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgfSxcclxuXHJcbiAgb25ETlNDaGFuZ2UoZTogYW55KSB7XHJcbiAgICBjb25zdCB7IGtleSB9ID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQ7XHJcbiAgICBjb25zdCB2YWx1ZSA9IGUuZGV0YWlsLnZhbHVlO1xyXG4gICAgY29uc3QgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xyXG4gICAgZGF0YVtgZG5zLiR7a2V5fWBdID0gdmFsdWU7XHJcbiAgICB0aGlzLnNldERhdGEoZGF0YSk7XHJcbiAgfSxcclxuXHJcbiAgY29ubmVjdCgpIHtcclxuICAgIGNvbnN0IGNvbm5lY3RlZCA9IHRoaXMuZGF0YS5jb25uZWN0ZWQ7XHJcbiAgICBpZiAoY29ubmVjdGVkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGRldmljZSA9IHRoaXMuZGF0YS5kZXZpY2U7XHJcbiAgICBjb25zdCBvcHRpb246IFdlY2hhdE1pbmlwcm9ncmFtLkNyZWF0ZUJMRUNvbm5lY3Rpb25PcHRpb24gPSB7XHJcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuZGV2aWNlSWQsXHJcbiAgICAgIHN1Y2Nlc3M6ICgpID0+IGNvbnNvbGUubG9nKGDov57mjqXmiJDlip9gKSxcclxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDov57mjqXlpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxyXG4gICAgfTtcclxuICAgIHd4LmNyZWF0ZUJMRUNvbm5lY3Rpb24ob3B0aW9uKTtcclxuICAgIHRoaXMuc2hvd0xvYWRpbmcoXCLmraPlnKjov57mjqVcIik7XHJcbiAgfSxcclxuXHJcbiAgZGlzY29ubmVjdCgpIHtcclxuICAgIGNvbnN0IGNvbm5lY3RlZCA9IHRoaXMuZGF0YS5jb25uZWN0ZWQ7XHJcbiAgICBpZiAoIWNvbm5lY3RlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBkZXZpY2UgPSB0aGlzLmRhdGEuZGV2aWNlO1xyXG4gICAgY29uc3Qgb3B0aW9uOiBXZWNoYXRNaW5pcHJvZ3JhbS5DbG9zZUJMRUNvbm5lY3Rpb25PcHRpb24gPSB7XHJcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuZGV2aWNlSWQsXHJcbiAgICAgIHN1Y2Nlc3M6ICgpID0+IGNvbnNvbGUubG9nKGDmlq3lvIDmiJDlip9gKSxcclxuICAgICAgZmFpbDogcmVzID0+IGNvbnNvbGUubG9nKGDmlq3lvIDlpLHotKXvvJoke3Jlcy5lcnJDb2RlfSAtICR7cmVzLmVyck1zZ31gKVxyXG4gICAgfTtcclxuICAgIHd4LmNsb3NlQkxFQ29ubmVjdGlvbihvcHRpb24pO1xyXG4gIH0sXHJcblxyXG4gIHdyaXRlKHN0cjogc3RyaW5nKSB7XHJcbiAgICBzdHIgPSBgJHtzdHJ9JHtlbmRTeW1ib2x9YDtcclxuICAgIGNvbnN0IGRldmljZSA9IHRoaXMuZGF0YS5kZXZpY2U7XHJcbiAgICBjb25zdCB2YWx1ZSA9IGVuY29kZVV0Zjgoc3RyKTtcclxuICAgIGNvbnN0IG9wdGlvbjI6IFdlY2hhdE1pbmlwcm9ncmFtLldyaXRlQkxFQ2hhcmFjdGVyaXN0aWNWYWx1ZU9wdGlvbiA9IHtcclxuICAgICAgZGV2aWNlSWQ6IGRldmljZS5kZXZpY2VJZCxcclxuICAgICAgc2VydmljZUlkOiBzZXJ2aWNlSWQsXHJcbiAgICAgIGNoYXJhY3RlcmlzdGljSWQ6IHdyaXRlQ2hhcmFjdGVyaXN0aWNJZCxcclxuICAgICAgdmFsdWU6IHZhbHVlLFxyXG4gICAgICBzdWNjZXNzOiAoKSA9PiBjb25zb2xlLmxvZyhg5YaZ5YWl5oiQ5Yqf77yaJHtzdHJ9YCksXHJcbiAgICAgIGZhaWw6IHJlcyA9PiBjb25zb2xlLmxvZyhg5YaZ5YWl5aSx6LSl77yaICR7cmVzLmVyckNvZGV9IC0gJHtyZXMuZXJyTXNnfWApXHJcbiAgICB9O1xyXG4gICAgd3gud3JpdGVCTEVDaGFyYWN0ZXJpc3RpY1ZhbHVlKG9wdGlvbjIpO1xyXG4gIH0sXHJcblxyXG4gIGtlZXBBbGl2ZSgpIHtcclxuICAgIGNvbnN0IHZhbHVlID0ge1xyXG4gICAgICBjbWQ6IGtlZXBBbGl2ZUNtZFxyXG4gICAgfTtcclxuICAgIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcclxuICAgIGludGVydmFsSUQgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLndyaXRlKHN0ciksIDIwICogMTAwMCk7XHJcbiAgfSxcclxuXHJcbiAgZ2V0U3RhdHVzKCkge1xyXG4gICAgY29uc3QgdmFsdWUgPSB7XHJcbiAgICAgIGNtZDogZ2V0U3RhdHVzQ21kXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgc3RyID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xyXG4gICAgdGhpcy53cml0ZShzdHIpO1xyXG4gIH0sXHJcblxyXG4gIG1vZGlmeShtb2RlOiBcImV0aGVybmV0XCIgfCBcIndpZmlcIiwgYWRkcmVzczogc3RyaW5nLCBtYXNrOiBzdHJpbmcsIGdhdGV3YXk6IHN0cmluZywgZG5zOiBzdHJpbmdbXSwgc3NpZD86IHN0cmluZywgcGFzc3dvcmQ/OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHZhbHVlID0ge1xyXG4gICAgICBjbWQ6IG1vZGlmeUNtZCxcclxuICAgICAgbW9kZTogbW9kZSxcclxuICAgICAgc3NpZDogc3NpZCxcclxuICAgICAgcGFzc3dvcmQ6IHBhc3N3b3JkLFxyXG4gICAgICBhZGRyZXNzOiBhZGRyZXNzLFxyXG4gICAgICBtYXNrOiBtYXNrLFxyXG4gICAgICBnYXRld2F5OiBnYXRld2F5LFxyXG4gICAgICBkbnM6IGRuc1xyXG4gICAgfTtcclxuICAgIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcclxuICAgIHRoaXMud3JpdGUoc3RyKTtcclxuICAgIHRoaXMuc2hvd0xvYWRpbmcoXCLmraPlnKjphY3nva7nvZHnu5xcIik7XHJcbiAgfSxcclxuXHJcbiAgc2hvd0xvYWRpbmcodGl0bGU6IHN0cmluZykge1xyXG4gICAgY29uc3Qgb3B0aW9uOiBXZWNoYXRNaW5pcHJvZ3JhbS5TaG93TG9hZGluZ09wdGlvbiA9IHtcclxuICAgICAgdGl0bGU6IHRpdGxlLFxyXG4gICAgICBtYXNrOiB0cnVlXHJcbiAgICB9O1xyXG4gICAgd3guc2hvd0xvYWRpbmcob3B0aW9uKTtcclxuICB9XHJcbn0pOyJdfQ==